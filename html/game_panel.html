<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/style.css">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>
<script type="text/javascript" src="js/jquery.countdown.js"></script>

<script>
	$(document).ready(function(){
		
		/*
		window.onbeforeunload = function() {
			return "그냥 나감";
		};
		
		window.onunload = function() {
			// 만약 게임중이면 징계먹이기
			return;
		};*/
		/*
		function disableF5(e) { 
			if ((e.which || e.keyCode) == 116) {
				e.preventDefault(); 
			}
		}
		$(document).on("keydown", disableF5);
		*/
		
		startDualGame();
		
	});
		
	function startTimer() {
		$('#timer').countdown(Date.now() + 10000, function(event) { 
			var remainingSecondsString =  event.strftime('%-S');
			$(this).text(remainingSecondsString); 
			if (parseInt(remainingSecondsString) == 0) {
				$(this).text('Time Over');
				inputAnwser();
			} else {
				$(this).css('color', 'red');
			}
		});	
	}
	
	function startDualGame() {
		alert('asas');
		ajaxData('start_dual_game');
		draw_screen();		
	}	
	
	function inputAnwser(){
		var text = document.getElementById('input_answer');
		var anwser = text.value;
		ajaxData('play', anwser);
		draw_screen();
	}
	
	var gameData = '';

	function ajaxData(thisAction, thisChar) {
	
		$.ajax({		
			url:'word_ajax.php',
			type: 'POST',
			async: false,
			data : { action : thisAction, user_input : thisChar },
			dataType: 'json',
			success : function(result){
				gameData = result;
				//alert(JSON.stringify(result));
			},
			error: function(xhr) {
				alert(JSON.stringify(xhr));
			},
		});
		return gameData;
	}
	
	var clientStatus =  '';
	var correctAnswer = '';
	var current = '';
	var wrong = '';
	var gameMode = '';
	var gameStatus = '';
	var userId = '';
	
	function fillCurrent(){
		var current_list = document.getElementById('current_list');
		current_list.innerHTML = '';

		var arr = current;
		for (var i = 0; i < arr.length; i++){
			var li = document.createElement('li');
			current_list.appendChild(li);
			li.innerHTML = arr[i];
		}
	}
	
	function fillWrong(){
		var wrong_list = document.getElementById('wrong_list');
		wrong_list.innerHTML = '';
		
		var arr = wrong;
		//alert(JSON.stringify(arr));
		//wrong_list.innerHTML = arr.join(', ');		
	}
	
	function draw_screen(){
		clientStatus =  gameData['status']; 
		correctAnswer = gameData['correct_answer'];
		current = gameData['current'];
		wrong = gameData['wrong'];
		//alert(JSON.stringify(wrong));
		gameMode = gameData['mode'];
		gameStatus = gameData['status'];
		userId = gameData['user_id']
		fillCurrent();
		fillWrong();
		
		if (gameMode === 'dual_game'){
			if (gameStatus === 'waiting') {
				document.getElementById('panel_wrap').style.display = 'none';
				document.getElementById('panel_result').style.display = 'none';
				document.getElementById('panel_waiting').style.display = '';
			} else if (gameStatus === 'my_turn' || gameStatus === 'enemy_turn')	{
				document.getElementById('panel_waiting').style.display = 'none';
				document.getElementById('panel_wrap').style.display = '';
				if (gameStatus === 'my_turn'){					
					document.getElementById('timer').style.display = '';
					startTimer();
					document.getElementById('input_answer').disabled = false;
					document.getElementById('input_button').disabled = false;
				} else{
					drawIfNeeded();
					document.getElementById('timer').style.display = 'none';
					document.getElementById('input_answer').disabled = true;
					document.getElementById('input_button').disabled = true;
				}
			} else if(gameStatus === 'win' || gameStatus === 'lose') {
				document.getElementById('panel_result').style.display = 'none';
				if (gameStatus === 'win'){
				
				} else if (gameStatus === 'lose') {
				
				}
			}
		}
	}
	
		
	function drawIfNeeded() {
		
		
		//alert(status + '44' + clientStatus);
		if (gameStatus === 'my_turn') {
			
		} else if (gameStatus === 'enemy_turn' || gameStatus === 'waiting') {
			ajaxData('fetch_status');
			draw_screen();
		}
		setTimeout (function() {
			drawIfNeeded();
		}, 10000);
	}
	
</script>
</head>

<body>


	

	<div id="panel_waiting">
		<div class="game_panel">
			<ul class="user_info">
				<li class="user_1">USER: <span id = "user1_id"></span></li>
				<li class="user_2">상대 PLAYER를 기다리는 중입니다.</li>
			</ul>
			<div class="panel_box">
				<div class="game_waiting">
				상대 PLAYER를 기다리는 중입니다.
				</div>
			</div>
		</div>
	</div>

		<div id="panel_wrap">
		<div class="game_panel">
			<ul class="user_info">
				<li class="user_1">
				USER: <span>유저1아이디</span>
					<div class="user_stat">
						<span>승률</span>
					</div>
				</li>
				<li class="user_2">
				USER: <span>유저2아이디</span>
					<div class="user_stat">
						<span>승률</span>
					</div>
				</li>
			</ul>
		</div>		
		<div class="panel_box">
			
			<span id="timer" class="timer">Timer not started yet</span>
			
			<div class="user_output">
				<ul id = "current_list">
				
				</ul>
			</div>
			<div class="user_input">
				<form id = "form">
					<ul>					
						<li><input id = "input_answer" type='text' name='user_input' size='35' autofocus></li>
						<li><input id = "input_button"type='button' value='Entre' onclick = "inputAnwser(this.form)"></li>
					</ul>
				</form>
			</div>
		</div>
	
	<div class="wrong_input">
		<ul>
			<li>틀린답</li>
			
			<li id = "wrong_list">			
				
			</li>
			
		</ul>
	</div>
		</div>


		<div class="user_output">
			<ul id = "current_list">
			
			</ul>
		</div>
	<div id = "panel_result">
		<div class="panel_box">
			<div class="game_result">
	
				<span>유저1</span> <span class="game_win">WIN</span> vs <span>유저2</span> <span class="game_lose">LOSE</span>
			

			</div>
		</div>
		<div class="wrong_input">
			<ul>
				<li>틀린답</li>
						
				<li id = "wrong_list">
				
				</li>
				
			</ul>
		</div>
		<div class="page_btn">
			<ul>				
				<li>
					<form action="change_mode.php" method="post">
						<input type="hidden" value="lobby" name="mode">
						<input type="submit" value="로비">		
					</form>
				</li>
			</ul>
		</div>
	</div>
<script>


	
	
</script>
</body>
<html>