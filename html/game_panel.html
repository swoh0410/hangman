<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/style.css">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>
<script type="text/javascript" src="js/jquery.countdown.js"></script>

<script>
	$(document).ready(function(){
		/*
		window.onbeforeunload = function() {
			return "그냥 나감";
		};
		
		window.onunload = function() {
			// 만약 게임중이면 징계먹이기
			return;
		};*/
		
		function disableF5(e) { 
			if ((e.which || e.keyCode) == 116) {
				e.preventDefault(); 
			}
		}
		$(document).on("keydown", disableF5);
		
		$('#timer').countdown(Date.now() + 10000, function(event) { 
			var remainingSecondsString =  event.strftime('%-S');
			$(this).text(remainingSecondsString); 
			if (parseInt(remainingSecondsString) == 0) {
				$(this).text('Time Over');
				$('#form').submit();
			} else {
			$(this).css('color', 'red');
			}
		});		
	});
	var gameData = '';
	function ajaxData(thisAction, thisChar) {
		$.ajax({		
			url:'word_ajax.php',
			type: 'POST',
			async: false,
			data : { action : thisAction, user_input : thisChar }
			dataType: 'json',
			success : function(result){
				gameData = result;
			}
		});
		return gameData;
	}
	
	function startDuelGame() {
		ajaxData('start_duel_game');
	}
	
	function fillCurrent(){
		var current_list = document.getElementById('current_list');
		current_list.innerHTML = '';
		
		var arr = current.split();
		for (var i = 0; i < arr.length; i++){			
			var li = document.createElement('li');
			current_list.appendChild(li);
			li.innerHTML = arr[i];
		}
	}

	function inputAnwser(form){
		var text = document.getElementById('input_answer');
		var anwser = text.value;
		ajaxData('play', anwser);
	}
	
	
	
	function fillWrong(){
		var wrong_list = document.getElementById('wrong_list');
		wrong_list.innerHTML = '';
		
		var arr = wrong;
		arr.join(", ");		
		wrong_list.innerHTML = arr[i];		
	}
	
	function draw_screen(){
		var clientStatus =  gameData['status']; 
		var correctAnswer = gameData['correct_answer'];
		var current = gameData['current'];
		var wrong = gameData['wrong'];
		var gameMode = gameData['mode'];
		var gameStatus = gameData['status'];
		var userId = gameData['user_id']
		fillCurrent();
		fillWrong();
		
		if (gameMode === 'dual_game'){
			if (gameStatus === 'waiting') {
			
			} else if (gameStatus === 'my_turn' || gameStatus === 'enemy_turn')	{
				if (gameStatus === 'my_turn'){
					document.getElementById('timer').style.disply = '';
					document.getElementById('input_answer').disabled = false;
					document.getElementById('input_button').disabled = false;
				} else{
					document.getElementById('timer').style.disply = 'none';
					document.getElementById('input_answer').disabled = true;
					document.getElementById('input_button').disabled = true;
				}
			} else if(gameStatus === 'win' || gameStatus === 'lose') {
				if (gameStatus === 'win'){
				
				} else if (gameStatus === 'lose') {
				
				}
			}
		}
	}
	
</script>
</head>

<body>

<script> 
	
	
	
</script>

	

	<div id="panel_wrap">
		<div class="game_panel">
			<ul class="user_info">
				<li class="user_1">USER: <span id = "user1_id"></span></li>
				<li class="user_2">상대 PLAYER를 기다리는 중입니다.</li>
			</ul>
			<div class="panel_box">
				<div class="game_waiting">
				상대 PLAYER를 기다리는 중입니다.
				</div>
			</div>
		</div>
	</div>

		<div id="panel_wrap">
		<div class="game_panel">
			<ul class="user_info">
				<li class="user_1">
				USER: <span>유저1아이디</span>
					<div class="user_stat">
						<span>승률</span>
					</div>
				</li>
				<li class="user_2">
				USER: <span>유저2아이디</span>
					<div class="user_stat">
						<span>승률</span>
					</div>
				</li>
			</ul>
		</div>		
		<div class="panel_box">
			
			<span id="timer" class="timer">Timer not started yet</span>
			
			<div class="user_output">
				<ul id = "current_list">
				
				</ul>
			</div>
			<div class="user_input">
				<form id = "form">
					<ul>					
						<li><input id = "input_answer" type='text' name='user_input' size='35' autofocus></li>
						<li><input id = "input_button"type='button' value='Entre' onclick = "inputAnwser(this.form)"></li>
					</ul>
				</form>
			</div>
		</div>
	
	<div class="wrong_input">
		<ul>
			<li>틀린답</li>
			
			<li id = "wrong_list">			
				
			</li>
			
		</ul>
	</div>
		</div>


		<div class="user_output">
			<ul id = "current_list">
			
			</ul>
		</div>
		<div class="panel_box">
			<div class="game_result">
<?php			
			if ($infoDto->getGamingStatus() === 'win') {
?>			
				<?php echo get_user_name_from_user_id (get_user_ids()[0]); ?> <span class="game_win">WIN</span> vs <?php echo get_user_name_from_user_id (get_user_ids()[1]); ?> <span class="game_lose">LOSE</span>
			
<?php
			} else if ($infoDto->getGamingStatus() === 'lose') {
?>
				<?php echo get_user_name_from_user_id (get_user_ids()[1]); ?> <span class="game_lose">LOSE</span> vs <?php echo get_user_name_from_user_id (get_user_ids()[0]); ?> <span class="game_win">WIN</span>

			</div>
		</div>
		<div class="wrong_input">
			<ul>
				<li>틀린답</li>
						
				<li id = "wrong_list">
				
				</li>
				
			</ul>
		</div>
		<div class="page_btn">
			<ul>				
				<li>
					<form action="change_mode.php" method="post">
						<input type="hidden" value="lobby" name="mode">
						<input type="submit" value="로비">		
					</form>
				</li>
			</ul>
		</div>
<?php

	
	} else if ($infoDto->getMode() === 'solo_game') {
		if($infoDto->getGamingStatus() === 'my_turn'){
			//echo implode(' ', $infoDto->getCorrectAnswer());
?>
	<div id="panel_wrap">
		<div class="game_panel">
			<ul class="user_info_solo">
				<li class="user_1">USER: <?php echo $infoDto->getId(); ?></li>
			</ul>
		</div>
<?php		
		print_ui();
?>		
		<div class="page_btn">
			<ul>
				<li>
					<form action="change_mode.php" method="post">
						<input type="hidden" value="solo_game" name="mode">
						<input type="submit" value="리셋">		
					</form>
				</li>
				<li>
					<form action="change_mode.php" method="post">
						<input type="hidden" value="lobby" name="mode">
						<input type="submit" value="로비">		
					</form>
				</li>
			</ul>
		</div>
	</div>
<?php
		} else if ($infoDto->getGamingStatus() === 'end'){
			//여기는 솔로게임이 끝났을때
?>

		<div id="panel_wrap">
			<div class="game_panel">
				<ul class="user_info_solo">
					<li class="user_1">USER: <?php echo $infoDto->getId(); ?></li>
				</ul>
				<div class="panel_box">
					<div class="solo_game_over">
					연습게임이 끝났습니다. 계속 하시겠습니까?
					</div>
				</div>
			</div>
		</div>
		<div class="page_btn">
			<ul>
				<li>
					<form action="change_mode.php" method="post">
						<input type="hidden" value="solo_game" name="mode">
						<input type="submit" value="리셋">		
					</form>
				</li>
				<li>
					<form action="change_mode.php" method="post">
						<input type="hidden" value="lobby" name="mode">
						<input type="submit" value="로비">		
					</form>
				</li>
			</ul>
		</div>
		
<?php		
		} else{
			die('솔로게임 getGamingStatus 에러');
		}
	} 
?>

<script>
	function ajaxStatus() {
		var status = '';
		$.ajax({		
			url:'game_ajax.php',
			async: false,
			success : function(result){
				status = result;
				//alert(result + ' ' + clientStatus);
			}
		});
		return status;
	}	

		
	
	function drawIfNeeded() {
		
		var status = ajaxStatus();
		//alert(status + '44' + clientStatus);
		if (status == 'my_turn') {
			
		} else if (status == 'enemy_turn') {
			ajaxData('fetch_status');
			draw_screen();
		}
		setTimeout (function() {
			drawIfNeeded();
		}, 3000);
	}
	
	drawIfNeeded();
</script>
</body>
<html>